#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.10"
# ///
"""Like tee, but redacts environment variable values from output."""

import argparse
import os
import sys


def build_redactions(min_length):
    """Build a list of (secret, replacement) pairs, longest first."""
    redactions = []
    for key, value in os.environ.items():
        if len(value) >= min_length:
            redactions.append((value, f"[{key}]"))
    redactions.sort(key=lambda kv: len(kv[0]), reverse=True)
    return redactions


def redact(line, redactions):
    for secret, replacement in redactions:
        if secret in line:
            line = line.replace(secret, replacement)
    return line


def main():
    parser = argparse.ArgumentParser(
        description="Like tee, but redacts environment variable values."
    )
    parser.add_argument("files", nargs="*", help="Output files")
    parser.add_argument("-a", "--append", action="store_true", help="Append to files")
    parser.add_argument(
        "--min-length",
        type=int,
        default=8,
        help="Minimum value length to redact (default: 8)",
    )
    args = parser.parse_args()

    redactions = build_redactions(args.min_length)

    mode = "a" if args.append else "w"
    outputs = []
    try:
        for path in args.files:
            outputs.append(open(path, mode))

        while True:
            line = sys.stdin.readline()
            if not line:
                break
            filtered = redact(line, redactions)
            sys.stdout.write(filtered)
            sys.stdout.flush()
            for out in outputs:
                out.write(filtered)
                out.flush()
    except KeyboardInterrupt:
        pass
    finally:
        for out in outputs:
            out.close()


if __name__ == "__main__":
    main()
